<!doctype html>
<html><head><meta charset="utf-8" /><title>Bastion</title><style>body{font-family:sans-serif;max-width:900px;margin:2rem auto} pre{background:#eee;padding:.75rem} .row{padding:.5rem;border:1px solid #ccc;margin:.5rem 0} .hidden{display:none}</style></head>
<body>
<h1>The Bastion</h1>
<div id="login"><h3>Login</h3><input id="pw" type="password" placeholder="Password"/><button onclick="login()">Login</button><div id="loginErr"></div></div>
<div id="app" class="hidden">
<h3>Pending requests</h3><div id="requests"></div><hr/>
<h3>Request detail</h3><div id="detail">Select one</div><hr/>
<h3>Audit log</h3><input id="q" placeholder="search"/><button onclick="loadAudit()">Search</button><div id="audit"></div>
</div>
<script>
let current=null;
async function login(){const r=await fetch('/api/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({password:document.getElementById('pw').value})});if(!r.ok){document.getElementById('loginErr').innerText='Invalid';return;}document.getElementById('login').classList.add('hidden');document.getElementById('app').classList.remove('hidden');loadPending();loadAudit();}
async function loadPending(){const data=await (await fetch('/api/requests/pending')).json();document.getElementById('requests').innerHTML=data.map(r=>`<div class='row'><b>${r.id}</b> [${r.status}]<br/>${r.preview}<br/><button onclick="show('${r.id}')">View</button></div>`).join('');}
async function show(id){current=await (await fetch('/request/'+id)).json();document.getElementById('detail').innerHTML=`<b>${current.plugin}.${current.action}</b><pre>${current.params}</pre><pre>${current.preview}</pre><button onclick='approve()'>Approve</button> <button onclick='reject()'>Reject</button>`;}
async function approve(){const r=await (await fetch('/api/request/'+current.id+'/approve',{method:'POST'})).json();alert('OTP: '+r.otp);show(current.id);loadPending();loadAudit();}
async function reject(){await fetch('/api/request/'+current.id+'/reject',{method:'POST',headers:{'content-type':'application/json'},body:'{}'});show(current.id);loadPending();loadAudit();}
async function loadAudit(){const q=document.getElementById('q').value||'';const data=await (await fetch('/api/audit?q='+encodeURIComponent(q))).json();document.getElementById('audit').innerHTML=data.map(a=>`<div class='row'>${new Date(a.timestamp).toISOString()} <b>${a.event}</b> ${a.request_id}<pre>${a.details}</pre></div>`).join('');}
</script>
</body></html>
